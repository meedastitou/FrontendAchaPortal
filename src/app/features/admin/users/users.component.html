<div class="page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Gestion des Utilisateurs</h1>
      <p>Creer, modifier et gerer les comptes utilisateurs</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      + Nouvel Utilisateur
    </button>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value">{{ totalUsers() }}</div>
      <div class="stat-label">Total utilisateurs</div>
    </div>
    <div class="stat-card accent">
      <div class="stat-value">{{ activeUsers() }}</div>
      <div class="stat-label">Utilisateurs actifs</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ adminCount() }}</div>
      <div class="stat-label">Administrateurs</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filters">
      <div class="filter-group search">
        <input
          type="text"
          placeholder="Rechercher par nom, email..."
          [ngModel]="searchTerm()"
          (ngModelChange)="searchTerm.set($event)"
        />
      </div>
      <div class="filter-group">
        <label>Role</label>
        <select [ngModel]="roleFilter()" (ngModelChange)="roleFilter.set($event)">
          <option value="all">Tous les roles</option>
          @for (role of roles; track role.value) {
            <option [value]="role.value">{{ role.label }}</option>
          }
        </select>
      </div>
    </div>
  </div>

  <!-- Loading & Error -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Chargement des utilisateurs...</p>
    </div>
  } @else if (error()) {
    <div class="error-container">
      <p class="error">{{ error() }}</p>
      <button class="btn btn-primary" (click)="loadUsers()">Reessayer</button>
    </div>
  } @else {
    <!-- Users Table -->
    <div class="table-card">
      <table class="data-table">
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Email</th>
            <th>Role</th>
            <th>Statut</th>
            <th>Derniere connexion</th>
            <th>Date creation</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.id) {
            <tr [class.inactive]="!user.actif">
              <td>
                <div class="user-cell">
                  <div class="avatar">{{ (user.prenom?.[0] || user.username[0]) | uppercase }}</div>
                  <div class="user-info">
                    <span class="username">{{ user.username }}</span>
                    <span class="fullname">{{ user.prenom }} {{ user.nom }}</span>
                  </div>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge" [class]="getRoleBadgeClass(user.role)">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td>
                <span class="status-badge" [class.active]="user.actif" [class.inactive]="!user.actif">
                  {{ user.actif ? 'Actif' : 'Inactif' }}
                </span>
              </td>
              <td class="date-col">{{ formatDate(user.derniere_connexion) }}</td>
              <td class="date-col">{{ formatDate(user.created_at) }}</td>
              <td class="actions-col">
                <div class="actions">
                  <button class="btn-icon" title="Modifier" (click)="openEditModal(user)">
                    <span class="icon">E</span>
                  </button>
                  <button
                    class="btn-icon"
                    [class.toggle-off]="user.actif"
                    [class.toggle-on]="!user.actif"
                    [title]="user.actif ? 'Desactiver' : 'Activer'"
                    (click)="toggleActive(user)"
                  >
                    <span class="icon">{{ user.actif ? 'D' : 'A' }}</span>
                  </button>
                  <button class="btn-icon" title="Reinitialiser MDP" (click)="resetPassword(user)">
                    <span class="icon">R</span>
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="7" class="empty-row">Aucun utilisateur trouve</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Modal: Create User -->
  @if (showCreateModal()) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Nouvel Utilisateur</h2>
          <button class="btn-close" (click)="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Nom d'utilisateur *</label>
            <input
              type="text"
              [ngModel]="createForm().username"
              (ngModelChange)="createForm.set({...createForm(), username: $event})"
              placeholder="ex: jdupont"
            />
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input
              type="email"
              [ngModel]="createForm().email"
              (ngModelChange)="createForm.set({...createForm(), email: $event})"
              placeholder="ex: jean.dupont@entreprise.com"
            />
          </div>
          <div class="form-group">
            <label>Mot de passe *</label>
            <input
              type="password"
              [ngModel]="createForm().password"
              (ngModelChange)="createForm.set({...createForm(), password: $event})"
              placeholder="Minimum 6 caracteres"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Prenom</label>
              <input
                type="text"
                [ngModel]="createForm().prenom"
                (ngModelChange)="createForm.set({...createForm(), prenom: $event})"
                placeholder="ex: Jean"
              />
            </div>
            <div class="form-group">
              <label>Nom</label>
              <input
                type="text"
                [ngModel]="createForm().nom"
                (ngModelChange)="createForm.set({...createForm(), nom: $event})"
                placeholder="ex: Dupont"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Role *</label>
            <select
              [ngModel]="createForm().role"
              (ngModelChange)="createForm.set({...createForm(), role: $event})"
            >
              @for (role of roles; track role.value) {
                <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeCreateModal()">Annuler</button>
          <button class="btn btn-primary" (click)="createUser()">Creer</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal: Edit User -->
  @if (showEditModal() && selectedUser()) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Modifier {{ selectedUser()!.username }}</h2>
          <button class="btn-close" (click)="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              [ngModel]="editForm().email"
              (ngModelChange)="editForm.set({...editForm(), email: $event})"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Prenom</label>
              <input
                type="text"
                [ngModel]="editForm().prenom"
                (ngModelChange)="editForm.set({...editForm(), prenom: $event})"
              />
            </div>
            <div class="form-group">
              <label>Nom</label>
              <input
                type="text"
                [ngModel]="editForm().nom"
                (ngModelChange)="editForm.set({...editForm(), nom: $event})"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Role</label>
            <select
              [ngModel]="editForm().role"
              (ngModelChange)="editForm.set({...editForm(), role: $event})"
            >
              @for (role of roles; track role.value) {
                <option [value]="role.value">{{ role.label }}</option>
              }
            </select>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input
                type="checkbox"
                [ngModel]="editForm().actif"
                (ngModelChange)="editForm.set({...editForm(), actif: $event})"
              />
              Utilisateur actif
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeEditModal()">Annuler</button>
          <button class="btn btn-primary" (click)="updateUser()">Enregistrer</button>
        </div>
      </div>
    </div>
  }

  <!-- Modal: Reset Password Result -->
  @if (showResetPasswordModal() && selectedUser()) {
    <div class="modal-overlay" (click)="closeResetPasswordModal()">
      <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header success">
          <h2>Mot de passe reinitialise</h2>
        </div>
        <div class="modal-body center">
          <p>Le mot de passe de <strong>{{ selectedUser()!.username }}</strong> a ete reinitialise.</p>
          <div class="password-box">
            <span class="label">Nouveau mot de passe temporaire:</span>
            <div class="password-value">
              <code>{{ tempPassword() }}</code>
              <button class="btn-copy" (click)="copyPassword()" title="Copier">
                Copier
              </button>
            </div>
          </div>
          <p class="warning">L'utilisateur devra changer ce mot de passe a sa prochaine connexion.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" (click)="closeResetPasswordModal()">Fermer</button>
        </div>
      </div>
    </div>
  }
</div>
